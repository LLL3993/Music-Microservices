12.24 通过 Spring Boot Actuator + Micrometer Tracing（Brave）+ Zipkin Reporter 实现分布式链路追踪

# 分布式链路追踪（Sleuth 思路 + Zipkin 落地）

## 目标

- 在 Docker 部署环境中接入 Zipkin，实现跨服务请求的链路追踪。
- 本地仅保证代码可编译、测试通过。

## 方案说明

当前项目基于 Spring Boot 3.x（各服务 `spring-boot-starter-parent` 为 3.5.x）。

- 等价落地方式为：Spring Boot Actuator + Micrometer Tracing（Brave）+ Zipkin Reporter。
- 效果与“使用 Sleuth 上报到 Zipkin”的目标一致：服务间通过 TraceId/SpanId 进行链路串联，并在 Zipkin UI 中检索与查看。

## 实现思路

### 1) 服务侧：生成 Trace + 上报 Zipkin

- 为每个服务引入 Micrometer Tracing 的 Brave bridge，并引入 Zipkin reporter。
- 在 `docker` profile 的 `application-docker.yml` 中：
  - 开启全量采样（便于演示与测试）。
  - 指定 Zipkin 上报地址（容器网络内访问 `zipkin:9411`）。
  - 使用 B3 传播格式，保证跨服务 Header 传播一致。

### 2) Docker 侧：新增 Zipkin 容器

- 在 `docker-compose.yml` 增加 `zipkin` 服务，暴露 `9411` 端口。
- 各微服务通过配置项 `management.zipkin.tracing.endpoint` 将 span 上报到 Zipkin。

## 代码与配置改动

### 1) Maven 依赖

在以下模块 `pom.xml` 增加：

- `io.micrometer:micrometer-tracing-bridge-brave`
- `io.zipkin.reporter2:zipkin-reporter-brave`

对应文件：

- `user-service/pom.xml`
- `meta-service/pom.xml`
- `list-service/pom.xml`
- `gateway-service/pom.xml`

### 2) Docker Profile：追踪与上报配置

在以下文件增加（或合并进现有 `management` 节点）：

```yml
management:
  tracing:
    sampling:
      probability: 1.0
    propagation:
      type: b3
  zipkin:
    tracing:
      endpoint: http://zipkin:9411/api/v2/spans
```

对应文件：

- `user-service/src/main/resources/application-docker.yml`
- `meta-service/src/main/resources/application-docker.yml`
- `list-service/src/main/resources/application-docker.yml`
- `gateway-service/src/main/resources/application-docker.yml`

补充：为保证 Feign 调用可观察（更容易形成跨服务链路），在 `list-service` 的 Docker 配置中启用：

```yml
spring:
  cloud:
    openfeign:
      micrometer:
        enabled: true
```

### 3) Docker Compose：新增 Zipkin

修改：`docker-compose.yml`

新增：

```yml
  zipkin:
    image: openzipkin/zipkin:3
    ports:
      - "9411:9411"
```

## Docker 环境测试命令（仅在有 Docker 的机器上执行）

### 1) 启动

在仓库根目录：

```bash
docker compose up -d --build
```

### 2) 打开 Zipkin

- Zipkin UI：`http://<server-ip>:9411/zipkin/`

### 3) 生成一条跨服务链路（gateway-service -> user-service）

下面用 `gateway-service` 作为网关调用 `user-service` 的注册接口，从而形成一条链路。

1) 创建用户（user-service）：

```bash
curl -fsS -X POST "http://localhost:8090/api/users" \
  -H "Content-Type: application/json" \
  -d '{"username":"trace-user","email":"trace-user@example.com","password":"123456","isAdmin":false}'
```

### 4) 在 Zipkin 中验证

- 进入 Zipkin UI 的 `Find Traces`。
- 选择 `Service Name`（通常会看到 `list-service`、`user-service`、`meta-service` 等）。
- 点击 `Find Traces`，打开任意 trace，预期能看到至少：
  - `gateway-service` 的入口 span
  - `gateway-service` 内部发起到 `user-service` 的客户端 span
  - `user-service` 的服务端 span

## 实现日志（可观察点）

- Zipkin UI 中可检索到 `gateway-service` 的请求链路。
- 同一条链路中，比如收藏时， `list-service -> user-service` 与 `list-service -> meta-service` 会使用同一个 TraceId 串联。
