12.24 对网页进行优化，增加管理界面用于管理用户和音乐，修改之前存在的一点问题

# 优化日志与实现过程

## 目标与问题

### 问题 1：拖动进度条后音乐立刻“重新播放”，无法从拖动位置续播

现象：
- 在底部播放条拖动进度条，或在遮罩层播放器中拖动进度条后，会触发音频从头开始播放（表现为“重播”）。

定位结论：
- 全局播放器在 `music-web/src/views/Layout.vue` 中维护 `<audio>`，通过事件 `player:seek` 接收跳转指令。
- 遮罩层页面 `music-web/src/views/Player.vue` 的进度条和歌词点击，会派发 `player:seek`，但在音频 `duration` 还未就绪时，`seekTo()` 会把最大值当作 `0`，导致 clamp 后跳转到 `0`，表现为“重播”。

修复方案：
- `seekTo()` 在 duration 未就绪时，不再把最大值视为 `0`，而是允许先记录“待跳转时间”，等 `loadedmetadata` 后再二次执行真正的跳转。

关键改动：
- `music-web/src/views/Layout.vue`：
  - 新增 `pendingSeek`，在 `seekTo()` 中当 `duration` 不可用时暂存 seek 请求。
  - 在 `onAudioLoadedMetadata()` 中检测 `pendingSeek` 并补偿执行 `seekTo()`。
- `music-web/src/views/Player.vue`：
  - `seekTo()` 计算 clamp 的上限时，`duration<=0` 视为无上限（避免直接 clamp 到 0）。

### 问题 2：遮罩层点击歌词跳转时音乐立刻“重新播放”

现象：
- 遮罩层歌词点击本应跳到对应时间，但点击后表现为从头开始。

定位结论：
- 根因与问题 1 相同：歌词点击会触发 `player:seek`，duration 未就绪时被 clamp 到 0。

修复方案：
- 与问题 1 同修（pending seek + duration 未就绪时不 clamp 到 0）。

### 二次定位补充：根因并非仅 duration 未就绪，而是音频静态资源不支持 Range

复现特征：
- 进度条拖动 / 歌词点击会修改 `audio.currentTime`，浏览器通常会对 mp3 发起带 `Range: bytes=...` 的分段请求，以便从文件中间位置开始解码。
- 本项目开发环境通过 Vite 自定义中间件直接读取 `../data` 目录返回资源，但此前只支持 `200` 全量响应，不支持 `Range`。

最终定位结论：
- 当浏览器发起 Range 请求时，服务端未按规范返回 `206 Partial Content` 以及对应的 `Content-Range`，导致音频 seek 行为退化/失败，表现为“跳回 0 重新播放”。

最终修复方案：
- 在 `music-web/vite.config.js` 的 `dataFolderPlugin()` 中补齐 `Range` 支持：
  - 返回 `Accept-Ranges: bytes`
  - 当请求包含 `Range` 时返回 `206`，并根据区间输出 `Content-Range` / `Content-Length`，以流方式读取对应字节段。

关键改动：
- `music-web/vite.config.js:19`：为 `/data/**` 资源补齐 Range/206 分段响应支持（mp3 seek 能正常从中间位置续播）。

## 需求优化

### 优化 1：管理员账号登录后，侧边栏出现“管理界面”，展示用户与音乐数据

实现思路：
- 登录后会将 `auth_user` 持久化到 `localStorage`，其中包含 `isAdmin` 字段（来自后端 JWT claim）。
- 前端侧边栏根据 `user.isAdmin` 条件渲染“管理界面”菜单。
- 新增管理页 `Admin.vue`：并行请求：
  - `GET /api/users`（用户列表）
  - `GET /api/meta`（音乐列表）
- 后端补充两个列表接口，并通过网关注入的 `X-User-Is-Admin` 头进行简单鉴权（非管理员返回 403）。

关键改动：
- `music-web/src/views/Layout.vue`：新增 `isAdmin` 计算属性与侧边栏入口。
- `music-web/src/router/index.js`：新增 `Admin` 路由。
- `music-web/src/views/Admin.vue`：新增管理界面展示用户表/音乐表。
- `user-service`：
  - `GET /api/users`（管理员可用）
  - `UserService.listUsers()` 支持查询列表
- `meta-service`：
  - `GET /api/meta`（管理员可用）
  - `MetaService.listAll()` 支持查询列表

### 优化 2：搜索结果点击播放按钮可直接播放

现象：
- 用户搜索出音乐后，点击播放按钮需要二次操作才能听到。

实现方案：
- 搜索结果播放按钮不再进入遮罩层页面，而是直接派发 `player:set` 到全局播放器开始播放。
- 仍保留 `goPlayer()` 用于“跳转到遮罩层”场景。

关键改动：
- `music-web/src/views/Search.vue`：新增 `playSong()`，播放按钮绑定为 `playSong()`。

## 关键日志（定位链路）

- 入口事件：
  - `Player.vue` 进度条与歌词点击：`window.dispatchEvent(new CustomEvent('player:seek', ...))`
  - `Layout.vue` 监听：`window.addEventListener('player:seek', onPlayerSeek)`
- 关键函数：
  - `Layout.vue`：`seekTo()` / `onAudioLoadedMetadata()`
  - `Player.vue`：`seekTo()` / `ensurePlayerHasSong()`
- 触发条件：
  - duration 未加载时进行 seek（拖动或点击歌词）导致 clamp 到 0

## 界面优化（图片替换与轮播）

### 优化 3：左上角 LOGO / 用户头像替换为 data/pic 下资源

实现方案：
- 左上角 LOGO：`/data/pic/icon.jpg`
- 用户头像：`/data/pic/user.jpg`

关键改动：
- `music-web/src/views/Layout.vue:59`：新增 `brandLogoUrl` / `userAvatarUrl`，并在模板中替换原本的占位图。

### 优化 4：发现页顶部 Banner 轮播（show_1~show_5）

实现方案：
- 轮播图片：`/data/pic/show_1.jpg` ~ `/data/pic/show_5.jpg`
- 自动轮播：每 5 秒切换一次
- 鼠标 hover 时显示左右按钮，点击可手动切换；hover 期间暂停自动切换

关键改动：
- `music-web/src/views/Discover.vue:1`：
  - 维护 `activeBanner` 与 `isHovering`
  - `setInterval(5000)` 在非 hover 时执行 `nextBanner()`
  - hover 时显示左右按钮并绑定 `prevBanner()` / `nextBanner()`

### 优化 5：发现页“推荐歌单”封面改为歌单第一首歌曲封面

需求：
- 歌单图片不再使用占位图，而是展示该歌单中第一首歌曲的封面。

实现方案：
- 发现页拉取当前用户的歌单列表（取前 3 个作为推荐），对每个歌单并行/逐个拉取歌单详情：
  - `GET /api/playlists/username`
  - `GET /api/playlist-details?playlistName=...`
- 使用详情列表第一首歌曲的 `songName` 组装封面地址：`/data/cover/<songName>.jpg`。

关键改动：
- `music-web/src/views/Discover.vue:42`：`loadRecommendedPlaylists()` 获取歌单与详情，并将 `coverUrl` 绑定到卡片 `<img>`。

### 优化 6：歌单详情页封面改为歌单第一首歌曲封面

需求：
- 进入某个歌单详情后，顶部的歌单封面应显示该歌单第一首歌曲的封面。

实现方案：
- 歌单详情数据 `details` 已包含歌曲列表，使用 `details[0].songName` 计算封面 URL（无歌曲时回退为占位图）。

关键改动：
- `music-web/src/views/Playlists.vue:38`：新增 `selectedPlaylistCoverUrl` 计算属性，并替换详情页封面 `:src` 绑定。

### 优化 7：管理界面补齐用户/音乐数据增删改查

需求：
- 管理界面需要对用户数据与音乐数据实现增删改查。

实现方案：
- 前端在管理页中增加两个弹窗表单（用户/音乐），支持新增与编辑，列表内支持删除按钮。
- 请求头统一携带 `Authorization` 与 `X-User-Is-Admin: true`，并复用现有微服务接口：
  - 用户：
    - `GET /api/users`
    - `POST /api/users`
    - `PUT /api/users/{id}`
    - `DELETE /api/users/{id}`
  - 音乐：
    - `GET /api/meta`
    - `POST /api/meta`
    - `PUT /api/meta/{id}`
    - `DELETE /api/meta/{id}`

关键改动：
- `music-web/src/views/Admin.vue:58`：`loadAll()` 并行拉取用户与音乐列表。
- `music-web/src/views/Admin.vue:117`：用户新增/编辑 `submitUser()`，完成后刷新列表。
- `music-web/src/views/Admin.vue:166`：用户删除 `deleteUser()`。
- `music-web/src/views/Admin.vue:214`：音乐新增/编辑 `submitSong()`，完成后刷新列表。
- `music-web/src/views/Admin.vue:248`：音乐删除 `deleteSong()`。

### 优化 8：侧边栏“管理界面”拆分为“用户管理 / 音乐管理”，并实现分页

需求：
- 点击侧边栏“管理界面”时不直接进入管理页，而是展开二级菜单“用户管理 / 音乐管理”。
- 用户数据和音乐数据分别放到两个界面中，并支持分页（10 条/页）。

实现方案：
- 路由层新增两个子路由：`/admin/users` 与 `/admin/music`，并复用同一个 `Admin.vue` 组件，通过 `route.name` 区分当前展示模块。
- 侧边栏将“管理界面”作为可展开父级菜单，点击后仅切换展开状态；二级菜单项分别跳转到对应路由。
- 分页逻辑放在前端（避免新增冗余接口）：页面一次拉取全量列表后，用 `computed + slice()` 做 10 条/页的分页展示，并提供上一页/下一页按钮。

关键改动：
- `music-web/src/views/Layout.vue`：侧边栏新增“管理界面”父菜单与二级菜单，支持展开/高亮/跳转。
- `music-web/src/router/index.js`：`Admin` 下新增 `AdminUsers` / `AdminMusic` 子路由。
- `music-web/src/views/Admin.vue`：按路由拆分“用户管理 / 音乐管理”视图，并添加 10 条/页分页 UI 与计算逻辑。

### 优化 9：发现页推荐歌单卡片布局优化，封面改为歌单最后一首歌曲

需求：
- 推荐歌单图片更突出，并与推荐区域保留空隙。
- 推荐歌单封面由歌单第一首歌改为最后一首歌。

实现方案：
- 发现页推荐区域改为横向滚动卡片列表，给每张卡固定更大的宽度，并设置 `gap` 与内边距营造留白。
- 拉取歌单详情后，取 `details[details.length - 1].songName` 作为封面（为空则回退占位图）。

关键改动：
- `music-web/src/views/Discover.vue:42`：推荐歌单封面从 `details[0]` 改为取最后一首歌。
- `music-web/src/views/Discover.vue:205`：推荐列表从 grid 改为横向滚动布局，卡片宽度与间距调整。

### 优化 10：遮罩层歌词框支持滚动，尺寸优化；封面暂停续转

需求：
- 遮罩层歌词显示框增加滚动条，宽度增大为现在的两倍，长度固定。
- 遮罩层滚动歌曲封面暂停时不重置，恢复播放后从暂停位置继续旋转。

实现方案：
- 布局：将遮罩层主体左列改为 `minmax(420px, 840px)`，以便在大屏下自动扩展到约 2 倍宽度；小屏保持原有响应式（`@media (max-width: 980px)` 仍改为单列）。
- 歌词框：固定高度 `260px`，开启 `overflow-y: auto`，并通过 `scrollbar-gutter: stable` 在有滚动条时避免内容跳动。
- 封面旋转：把旋转动画常驻在 `.cover-wrap` 上，默认 `animation-play-state: paused`；播放时仅切换为 `running`，从而暂停时停留在当前角度不回到初始状态。

关键改动：
- `music-web/src/views/Player.vue:373`：左列宽度调整为 `minmax(420px, 840px)`。
- `music-web/src/views/Player.vue:388`：封面旋转改为 `animation-play-state` 控制，暂停续转。
- `music-web/src/views/Player.vue:430`：歌词框固定高度并开启纵向滚动。

### 优化 11：底部控制面板宽度适度收窄

需求：
- 下方控制面板宽度稍微缩小一点。

实现方案：
- 给播放条内部容器增加 `max-width` 并水平居中，让控制面板在大屏下更紧凑，视觉更聚焦。

关键改动：
- `music-web/src/views/Layout.vue:1269`：`.playerbar-inner` 增加 `max-width: 1120px; margin: 0 auto;`。

