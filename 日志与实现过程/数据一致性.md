12.23 通过本地消息表+rabbitmq实现数据一致性

# 数据一致性（本地消息表 Outbox + 消费幂等 Inbox）

## 目标

- 解决“业务数据提交成功，但 RabbitMQ 事件发布失败”导致的数据不一致。
- 解决“RabbitMQ 至少一次投递”带来的重复消息，避免 `list-service` 重复清理。
- 仅在 Docker 部署场景启用（`docker` profile），本地运行不依赖 RabbitMQ / Docker。

## 适用范围

- 发布侧（Outbox）：`user-service`、`meta-service`
- 消费侧（Inbox 幂等）：`list-service`

## 设计概览

### 1) 发布侧：Outbox（本地消息表）

- 业务事务中：把要发布的事件先写入本地表 `outbox_event`（状态 `PENDING`）。
- 后台定时任务：批量扫描 `PENDING`，投递到 RabbitMQ 成功后更新为 `SENT`；失败则增加重试次数并计算下一次投递时间（指数退避）。

这样可以保证：业务数据与“需要发布的事件记录”在同一事务中提交，避免消息丢失。

### 2) 消费侧：Inbox（去重表）

- 每条消息都带 `eventId`（UUID）。
- `list-service` 消费时先对 `eventId` 做“插入去重”：`insert ignore into inbox_event ...`。
- 插入成功代表首次处理：执行清理并提交事务。
- 插入失败代表重复消息：直接跳过。

这样可以保证：重复投递不会导致重复清理（幂等）。

## 表结构（MySQL）

### 1) `user-service` / `meta-service`：`outbox_event`

两者结构一致，各自存在于自己的库里（`user_db` / `meta_db`）。

```sql
create table if not exists outbox_event (
  id varchar(36) not null,
  exchange_name varchar(255) not null,
  routing_key varchar(255) not null,
  payload_json longtext not null,
  status varchar(16) not null,
  attempt_count int not null,
  next_attempt_at datetime(6) null,
  created_at datetime(6) not null,
  sent_at datetime(6) null,
  last_error varchar(1000) null,
  primary key (id),
  index idx_outbox_status_next (status, next_attempt_at),
  index idx_outbox_created (created_at)
);
```

字段说明：

- `payload_json`：事件 JSON（示例：`{eventId, occurredAt, username}` / `{eventId, occurredAt, songName}`）
- `status`：`PENDING` / `SENT`
- `attempt_count` + `next_attempt_at`：失败重试控制（指数退避）
- `last_error`：最近一次失败原因（截断到 1000 字符）

### 2) `list-service`：`inbox_event`

存在于 `list_db`，用于消费去重。

```sql
create table if not exists inbox_event (
  id varchar(36) not null,
  routing_key varchar(255) not null,
  processed_at datetime(6) not null,
  primary key (id),
  index idx_inbox_processed (processed_at)
);
```

## 关键代码位置

### 1) `user-service` Outbox

- 事件入库：`user-service/src/main/java/com/zjsu/lyy/user_service/messaging/RabbitUserEventPublisher.java`
- 本地表实体/投递任务：`user-service/src/main/java/com/zjsu/lyy/user_service/outbox/*`

### 2) `meta-service` Outbox

- 事件入库：`meta-service/src/main/java/com/zjsu/lyy/meta_service/messaging/RabbitMetaEventPublisher.java`
- 本地表实体/投递任务：`meta-service/src/main/java/com/zjsu/lyy/meta_service/outbox/*`

### 3) `list-service` Inbox 幂等

- 去重表：`list-service/src/main/java/com/zjsu/lyy/list_service/inbox/*`
- 消费处理：`list-service/src/main/java/com/zjsu/lyy/list_service/messaging/ListEventHandlerService.java`
- Rabbit 监听：`list-service/src/main/java/com/zjsu/lyy/list_service/messaging/ListEventConsumer.java`

## Docker 环境验证（仅在有 Docker 的机器上执行）

### 1) 启动

```bash
docker compose up -d --build
```

### 2) 触发事件

- 删除用户：调用 `user-service` 删除接口（通过网关或直连）
- 删除歌曲：调用 `meta-service` 删除接口

观察日志：

- `user-service` / `meta-service`：出现 `Outbox enqueued ...`，随后出现 `Outbox published ...`
- `list-service`：首次消费会打印 `Consumed ...`；重复投递不会重复打印消费日志

## 本地运行说明

- 本地直接执行 `./mvnw test` 或 `./mvnw -q -DskipTests package` 不需要 Docker。
- RabbitMQ 相关 Bean/Listener/Outbox 投递任务均使用 `@Profile("docker")` 隔离，本地不会尝试连接 RabbitMQ。

