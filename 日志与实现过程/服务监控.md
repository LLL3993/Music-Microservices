# 服务监控（Prometheus + Grafana）

## 目标

- 在 Docker 部署环境中接入 Prometheus + Grafana，实现对各微服务的基础监控。
- 通过 Spring Boot Actuator + Micrometer 暴露 Prometheus 指标端点。
- 本地无 Docker 环境：不运行任何 Docker 命令；本地仅保证代码可编译、测试通过。

## 实现思路

### 1) 指标采集：Spring Boot -> Prometheus

- 每个服务引入 `micrometer-registry-prometheus`。
- 在 `docker` profile 的 `application-docker.yml` 中暴露 `prometheus` 端点：`/actuator/prometheus`。
- Prometheus 通过容器网络直接抓取各服务的 `http://<service-name>:<port>/actuator/prometheus`。

涉及服务：

- `gateway-service`（8090）
- `user-service`（8081）
- `user-service-2`（8084）
- `meta-service`（8082）
- `list-service`（8083）

### 2) 可视化：Grafana

- Grafana 作为独立容器运行。
- 数据源选择 Prometheus（URL：`http://prometheus:9090`）。
- 仪表盘可直接导入社区 Dashboard（Spring Boot / JVM / Micrometer）。

## 代码与配置改动

### 1) Maven 依赖

在以下模块 `pom.xml` 增加：`io.micrometer:micrometer-registry-prometheus`

- `user-service/pom.xml`
- `meta-service/pom.xml`
- `list-service/pom.xml`
- `gateway-service/pom.xml`

### 2) Docker Profile 暴露 Prometheus 指标端点

四个服务的 `application-docker.yml` 调整为：

```yml
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
```

对应文件：

- `user-service/src/main/resources/application-docker.yml`
- `meta-service/src/main/resources/application-docker.yml`
- `list-service/src/main/resources/application-docker.yml`
- `gateway-service/src/main/resources/application-docker.yml`

### 3) Prometheus 配置文件

新增：`monitoring/prometheus/prometheus.yml`

抓取目标为：

- `gateway-service:8090/actuator/prometheus`
- `user-service:8081/actuator/prometheus`
- `user-service-2:8084/actuator/prometheus`
- `meta-service:8082/actuator/prometheus`
- `list-service:8083/actuator/prometheus`

### 4) Docker Compose 新增 Prometheus + Grafana

修改：`docker-compose.yml`

- 新增 `prometheus`（对外端口 `9090`）
- 新增 `grafana`（对外端口 `3000`）
- 新增数据卷 `prometheus_data`、`grafana_data`

## Docker 环境测试命令（仅在有 Docker 的机器上执行）

### 1) 启动

在仓库根目录：

```bash
docker compose up -d --build
```

### 2) 验证 Prometheus 抓取是否成功

- 打开 Prometheus：`http://<server-ip>:9090/`
- 进入 `Status -> Targets`
- 预期各 job 为 `UP`

也可以直接访问任意服务的指标端点（示例）：

```bash
curl -fsS "http://<server-ip>:8081/actuator/prometheus" | head
curl -fsS "http://<server-ip>:8090/actuator/prometheus" | head
```

### 3) Grafana 配置

- 打开 Grafana：`http://<server-ip>:3000/`
- 默认账号密码：`admin/admin`（可通过环境变量覆盖）

添加数据源：

- Data source type：Prometheus
- URL：`http://prometheus:9090`

### 4) 可选：导入 Dashboard

在 Grafana 的 `Dashboards -> Import` 中可导入社区 Dashboard（示例：Spring Boot / JVM）。

## 实现日志（可观察点）

- Prometheus `Targets` 页面：各服务为 `UP`。
- 访问 `http://<server-ip>:<port>/actuator/prometheus` 能看到指标文本。
- Grafana 添加 Prometheus 数据源后，探索（Explore）能查询到 `jvm_memory_used_bytes` 等指标。

